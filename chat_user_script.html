<script type="text/javascript" src="js/socket.io.js"></script>
        <script>
           var current_user_id = document.getElementById('current_user_id').value;
           var userName = document.getElementsByClassName('userName')[0].title;
           const messagediv = document.getElementById('conversation-body');
           var inRoom = false;
           var failedFind = true;
           var inter;
           var timeout;
           var socket = io.connect('http://localhost:8084');
            socket.on('connect', function () {
                socket.send('regular user connected to server');
                socket.on('message', function (msg) {
                    console.log(msg);
                    if(msg == "There are no available rooms right now, please wait for a chat supervisor to become available"){
                      failedFind = true;
                      if(inRoom == false && failedFind == true){
                        document.getElementById('rep-name').innerHTML = "Awaiting Chat...";
                        console.log('Retrying connection...');
                        $("#conversation-body").append($('<p style="font-weight:bold">').text(msg));
                        $("#conversation-body").append($('<p style="color: rgb(0 0 0 / 50%);text-align: center;margin-bottom: 0;">').text('Retrying connection...'));
                        var shouldScroll = messagediv.scrollTop + messagediv.clientHeight !== messagediv.scrollHeight;
                        if (shouldScroll){
                            scrollToBottom();
                        }
                        inter = setTimeout(function(){ 
                            openChat();
                        }, 3000);
                      }
                    }
                });
                socket.on('chat_message_received', function(message, c_u_id){
                    var today = new Date();
                    var minutes = today.getMinutes();
                    var hours = today.getHours();
                    var ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12;
                    if (minutes < 10){
                      minutes = '0' + minutes;
                    }
                    var time = today.getHours() + ":" + minutes;
                    console.log('chat message received', message);
                    if(c_u_id == userName){
                      
                      $("#conversation-body").append($('<p class="bg-info text-white border-info" style="margin-left: auto;margin-bottom:0px;border: 2px solid lightgrey;border-radius: 1rem;padding: 5px 15px;width: max-content;background-color: lightgrey;color: black;white-space: unset;overflow: auto;overflow-wrap: anywhere;max-width: 100%;">').text(message)) //.append('<strong> :You</strong>'));
                        $("#conversation-body").append($('<p style="text-align:right;margin-bottom:0px;color: grey;">').text(c_u_id + ' ' + time + ampm));
                    }else{
                        $("#conversation-body").append($('<p class="bg-secondary text-white border-secondary" style="margin-bottom:0px;border: 2px solid lightgrey;border-radius: 1rem;padding: 5px 15px;width: max-content;background-color: lightgrey;color: black;white-space: unset;overflow: auto;overflow-wrap: anywhere;max-width: 100%;">').text(message)) //.append('<strong> :You</strong>'));
                        $("#conversation-body").append($('<p style="margin-bottom:0px;color: grey;">').text(c_u_id + ' ' + time + ampm));
                    }
                    var shouldScroll = messagediv.scrollTop + messagediv.clientHeight !== messagediv.scrollHeight;
                    if (shouldScroll){
                        scrollToBottom();
                    }
                })
                socket.on('user_joined', function(user, user_id){
                  if(user_id == userName){
                    $("#conversation-body").append($('<p style="color: rgb(0 0 0 / 50%);text-align: center;margin-bottom: 0;">').text('You have joined a chat supervisor\'s room'));
                    document.getElementById('rep-name').innerHTML = "Connected";
                  }else{
                    $("#conversation-body").append($('<p style="color: rgb(0 0 0 / 50%);text-align: center;margin-bottom: 0;">').text(user_id + ' has joined the room'));
                    //document.getElementById('rep-name').innerHTML = user_id;
                    document.getElementById('rep-name').innerHTML = "Connected";
                    var shouldScroll = messagediv.scrollTop + messagediv.clientHeight !== messagediv.scrollHeight;
                    if (shouldScroll){
                        scrollToBottom();
                    }
                  }
                })
                socket.on('user_left', function(user, user_id){
                  $("#conversation-body").append($('<p style="color: rgb(0 0 0 / 50%);text-align: center;margin-bottom: 0;">').text(user_id + ' has left the room'));
                    document.getElementById('rep-name').innerHTML = "Awaiting Chat...";
                    var shouldScroll = messagediv.scrollTop + messagediv.clientHeight !== messagediv.scrollHeight;
                    if (shouldScroll){
                        scrollToBottom();
                    }
                })
                socket.on('display_typing', function(status, user_id){
                  var typing_notif = document.getElementById('typing-notif');
                  if(status == true){
                    if(user_id == userName){
                    }else{
                      typing_notif.innerHTML = user_id + ' is typing...'
                      typing_notif.style.visibility = "visible";
                    }
                  }else{
                    typing_notif.style.visibility = 'hidden';
                  }
                })
            });  
            $('#input-message').keypress((e) =>{ 
              if(e.which != 13){
                typing = true;
                socket.emit('typing', true, userName);
                clearTimeout(timeout)
                timeout = setTimeout(function(){
                  typing = false;
                  socket.emit('typing', false, userName);
                }, 1500)
              }else{
                clearTimeout(timeout)
                typing = false
                socket.emit('typing', false, userName);
              }
            })
            function openChat(){
                socket.emit('join_random_room', userName);
                updateDate();
                document.getElementById('chat-button').style.display = "none";
                document.getElementById('chat-widget').style.display = "flex";
            }
            function closeChat(){
                socket.emit('leave_room', userName)
                inRoom = false;
                failedFind = false;
                if(inter !== undefined){
                    clearInterval(inter);
                }
                document.getElementById('chat-button').style.display = "inline-block";
                document.getElementById('chat-widget').style.display = "none";
            }
            $('#message-form').submit(function(e){
                e.preventDefault();
                socket.emit('chat_message', $('#input-message').val(), userName);
                $('#input-message').val('');
                return false;
            })
            function scrollToBottom(){
              messagediv.scrollTop = messagediv.scrollHeight;
            }
            function updateDate(){
              var d = new Date();
              var weekday = new Array(7);
              var hours = d.getHours();
              var ampm = hours >= 12 ? 'PM' : 'AM';
              hours = hours % 12;
              hours = hours ? hours : 12;
              weekday[0] = "SUN";
              weekday[1] = "MON";
              weekday[2] = "TUES";
              weekday[3] = "WED";
              weekday[4] = "THURS";
              weekday[5] = "FRI";
              weekday[6] = "SAT";
              var minutes = d.getMinutes();
              if (minutes < 10){
                minutes = '0' + minutes;
              }
              var time = d.getHours() + ":" + minutes;

              var n = weekday[d.getDay()];
              document.getElementById('message-date').innerHTML = n + ' ' + time + ampm;
            }
        </script>